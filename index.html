// Google Maps API キー認証と住所変換問題の修正

// 1. Google Maps API キーと読み込み方法の修正
// スクリプト読み込み部分（HTMLの最後に配置）
/*
<script>
    // グローバル変数
    let map;
    let directionsService;
    let directionsRenderer;
    let markers = [];
    let addresses = [];
    let optimizedAddresses = [];
    let geocoder;
    let currentPosition = null;
    
    // 初期化処理
    document.addEventListener('DOMContentLoaded', function() {
        initCamera();
        initEventListeners();
    });
    
    // Google マップAPIの読み込み - APIキーの問題を修正
    function loadGoogleMapsApi() {
        if (document.getElementById('google-maps-api')) {
            return;
        }
        
        const script = document.createElement('script');
        script.id = 'google-maps-api';
        // ここでAPIキーを正しく設定 - 適切なリファラを設定したAPIキーを使用する
        script.src = 'https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&callback=initMap';
        script.defer = true;
        script.async = true;
        document.head.appendChild(script);
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places&callback=handleGoogleMapsApiLoaded"></script>
*/

// 2. Google Maps API読み込み完了ハンドラー
function handleGoogleMapsApiLoaded() {
    console.log("Google Maps API loaded successfully");
    // APIが読み込まれたフラグを設定
    window.googleMapsLoaded = true;
    
    // 現在のステップに応じた処理
    if (document.getElementById('step3').classList.contains('visible') || 
        !document.getElementById('step3').classList.contains('hidden')) {
        initMap();
    }
}

// 3. 住所のジオコーディングと最適化 - APIキーエラー対策
async function geocodeAndOptimizeAddresses() {
    try {
        // APIが読み込まれているか確認
        if (typeof google === 'undefined' || !google.maps) {
            throw new Error("Google Maps APIが正しく読み込まれていません。");
        }
        
        // currentPositionが未設定の場合、デフォルト値を設定
        if (!currentPosition) {
            console.log("currentPositionが未設定のため、デフォルト位置を使用します");
            currentPosition = { lat: 35.0116, lng: 135.7681 }; // 京都市中心付近
        }
        
        // geocoderの初期化
        if (!geocoder) {
            geocoder = new google.maps.Geocoder();
        }
        
        // 全ての住所を緯度経度に変換
        const locations = [];
        for (const address of addresses) {
            try {
                // 日本の住所であることを明示してジオコーディング精度を向上
                const location = await geocodeAddress(address + ", 日本");
                locations.push({
                    ...location,
                    originalAddress: address
                });
                console.log(`住所を変換しました: ${address} => ${location.lat}, ${location.lng}`);
            } catch (error) {
                console.error(`住所の変換に失敗: ${address}`, error);
                // エラーでも処理を続行し、変換できた住所だけでルートを計算
                document.getElementById('errorMessage').innerHTML += `<br>住所「${address}」の変換に失敗しました。`;
                document.getElementById('errorMessage').style.display = 'block';
                continue;
            }
        }
        
        if (locations.length === 0) {
            throw new Error("有効な住所が見つかりませんでした。");
        }
        
        // 最適化されたルートを計算
        optimizedAddresses = nearestNeighborAlgorithm(currentPosition, locations);
        console.log("最適化されたルート:", optimizedAddresses);
        
        // マップを表示
        document.getElementById('map').style.display = 'block';
        
        // ルートとマーカーを表示
        displayRoute(currentPosition, optimizedAddresses);
        
        // 最適化された住所リストを表示
        displayOptimizedAddressList(optimizedAddresses);
        
        // ステップ3に進む
        document.getElementById('loadingProcess').style.display = 'none';
        document.getElementById('processAddressesButton').disabled = false;
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.remove('hidden');
        
    } catch (error) {
        console.error("ルート最適化エラー:", error);
        alert("ルートの最適化中にエラーが発生しました: " + error.message);
        document.getElementById('errorMessage').innerHTML = error.message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('loadingProcess').style.display = 'none';
        document.getElementById('processAddressesButton').disabled = false;
    }
}

// 4. 住所を緯度経度に変換 - エラーハンドリング強化
function geocodeAddress(address) {
    return new Promise((resolve, reject) => {
        if (!geocoder) {
            if (typeof google !== 'undefined' && google.maps) {
                geocoder = new google.maps.Geocoder();
            } else {
                reject(new Error("Google Maps APIが読み込まれていません"));
                return;
            }
        }
        
        // 日本の住所であることを明示し、地域バイアスを設定
        const geocodingOptions = {
            address: address,
            region: 'jp',
            componentRestrictions: {
                country: 'JP'
            }
        };
        
        geocoder.geocode(geocodingOptions, (results, status) => {
            if (status === "OK" && results && results.length > 0) {
                resolve({
                    lat: results[0].geometry.location.lat(),
                    lng: results[0].geometry.location.lng(),
                    formattedAddress: results[0].formatted_address
                });
            } else {
                console.error(`Geocoding失敗 (${status}):`, address);
                reject(new Error(`住所の変換に失敗しました: ${address} (Status: ${status})`));
            }
        });
    });
}

// 5. 位置情報取得のタイムアウト対応
function processAddresses() {
    document.getElementById('loadingProcess').style.display = 'block';
    document.getElementById('processAddressesButton').disabled = true;
    document.getElementById('errorMessage').style.display = 'none';
    
    // 入力された住所を取得
    const addressText = document.getElementById('addressesTextarea').value.trim();
    if (!addressText) {
        alert("住所を入力してください");
        document.getElementById('loadingProcess').style.display = 'none';
        document.getElementById('processAddressesButton').disabled = false;
        return;
    }
    
    // 住所をリスト化
    addresses = addressText.split('\n').filter(address => address.trim() !== "");
    
    // デフォルト位置を設定 (京都市中心付近)
    currentPosition = { lat: 35.0116, lng: 135.7681 };
    console.log("デフォルト位置を設定:", currentPosition);
    
    // 位置情報取得 - タイムアウト時間を10秒に延長
    if (navigator.geolocation) {
        const positionPromise = new Promise((resolve) => {
            const locationTimeout = setTimeout(() => {
                console.log("位置情報取得がタイムアウトしました。デフォルト位置を使用します。");
                document.getElementById('errorMessage').innerHTML = 
                    '位置情報の取得がタイムアウトしました。デフォルト位置（京都市中心）を使用します。';
                document.getElementById('errorMessage').style.display = 'block';
                resolve(currentPosition);
            }, 10000); // 10秒タイムアウト
            
            navigator.geolocation.getCurrentPosition(
                // 成功時
                function(position) {
                    clearTimeout(locationTimeout);
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log("現在位置を取得しました:", currentPosition);
                    resolve(currentPosition);
                },
                // エラー時
                function(error) {
                    clearTimeout(locationTimeout);
                    console.error('位置情報の取得に失敗しました:', error);
                    console.log("デフォルト位置を使用します:", currentPosition);
                    
                    // エラーメッセージ表示
                    let errorMessage = "";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "位置情報へのアクセスが拒否されました。";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "位置情報が利用できません。";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "位置情報の取得がタイムアウトしました。";
                            break;
                        default:
                            errorMessage = "位置情報の取得中にエラーが発生しました。";
                            break;
                    }
                    
                    document.getElementById('errorMessage').innerHTML = 
                        errorMessage + ' デフォルト位置（京都市中心）を使用します。';
                    document.getElementById('errorMessage').style.display = 'block';
                    
                    resolve(currentPosition);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10秒タイムアウト
                    maximumAge: 0
                }
            );
        });
        
        // 位置情報の処理が完了したらGoogle Mapsを初期化
        positionPromise.then(() => {
            // Google Mapsの初期化と住所の処理
            if (typeof google !== 'undefined' && google.maps) {
                // Google Maps APIが既に読み込まれている場合
                initMap();
            } else {
                // APIがまだ読み込まれていない場合、読み込んでから初期化
                loadGoogleMapsApi();
            }
        });
    } else {
        alert('お使いのブラウザは位置情報サービスをサポートしていません。デフォルトの位置情報を使用します。');
        document.getElementById('errorMessage').innerHTML = 
            'お使いのブラウザは位置情報サービスをサポートしていません。デフォルト位置（京都市中心）を使用します。';
        document.getElementById('errorMessage').style.display = 'block';
        
        // Google Mapsの初期化（デフォルト位置で）
        if (typeof google !== 'undefined' && google.maps) {
            initMap();
        } else {
            loadGoogleMapsApi();
        }
    }
}

// 6. 最適ルート計算と表示処理の改善
function displayRoute(start, optimizedLocations) {
    if (!start || !optimizedLocations || optimizedLocations.length === 0) {
        console.error('ルート表示に必要なデータがありません', { start, locationsCount: optimizedLocations ? optimizedLocations.length : 0 });
        return;
    }
    
    // マーカーをクリア
    clearMarkers();
    
    // 現在地のマーカー
    const startMarker = new google.maps.Marker({
        position: start,
        map: map,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: "#0f9d58",
            fillOpacity: 1,
            strokeWeight: 0,
            scale: 12
        },
        title: "現在地"
    });
    markers.push(startMarker);
    
    // 訪問先マーカー
    for (let i = 0; i < optimizedLocations.length; i++) {
        const marker = new google.maps.Marker({
            position: { lat: optimizedLocations[i].lat, lng: optimizedLocations[i].lng },
            map: map,
            label: {
                text: String(i + 1),
                color: "white"
            },
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: "#4285f4",
                fillOpacity: 1,
                strokeWeight: 0,
                scale: 12
            },
            title: optimizedLocations[i].formattedAddress || optimizedLocations[i].originalAddress
        });
        
        markers.push(marker);
    }
    
    // ルートが1か所しかない場合はDirections APIを使わず、地図の中心と拡大率だけ調整
    if (optimizedLocations.length === 1) {
        map.setCenter(optimizedLocations[0]);
        map.setZoom(14);
        return;
    }
    
    // Google Maps Directions APIでルートを表示
    try {
        // 最大8か所までに制限（Directions APIの制限）
        const maxWaypoints = Math.min(optimizedLocations.length - 1, 7); // 目的地を除いて最大7ウェイポイント
        const waypoints = optimizedLocations.slice(0, maxWaypoints).map(location => ({
            location: new google.maps.LatLng(location.lat, location.lng),
            stopover: true
        }));
        
        const request = {
            origin: new google.maps.LatLng(start.lat, start.lng),
            destination: new google.maps.LatLng(
                optimizedLocations[optimizedLocations.length - 1].lat, 
                optimizedLocations[optimizedLocations.length - 1].lng
            ),
            waypoints: waypoints,
            optimizeWaypoints: false,
            travelMode: google.maps.TravelMode.DRIVING
        };
        
        directionsService.route(request, (result, status) => {
            if (status === "OK") {
                directionsRenderer.setDirections(result);
            } else {
                console.error("ルート計算エラー:", status);
                document.getElementById('errorMessage').innerHTML = `ルート計算エラー: ${status}。マーカーのみ表示します。`;
                document.getElementById('errorMessage').style.display = 'block';
                // ルート計算に失敗した場合でもマーカーは表示されるので、
                // 地図の表示領域を調整
                fitMapToMarkers();
            }
        });
    } catch (error) {
        console.error("ルート表示エラー:", error);
        document.getElementById('errorMessage').innerHTML = `ルート表示エラー: ${error.message}。マーカーのみ表示します。`;
        document.getElementById('errorMessage').style.display = 'block';
        fitMapToMarkers();
    }
}

// 7. Google マップAPIキーの修正方法
/*
重要: Google Maps APIキーの問題を修正するには、以下の手順を実施してください:

1. Google Cloud Platformコンソール(https://console.cloud.google.com/)にアクセス
2. プロジェクトを選択または新規作成
3. APIとサービス > 認証情報 を選択
4. API キーを作成 をクリック
5. 制限を設定:
   - アプリケーションの制限: HTTP リファラー
   - ウェブサイトの制限: アプリをホストするドメインを追加（開発中は localhost を含む）
   - API制限: 以下のAPIのみに制限
     - Maps JavaScript API
     - Geocoding API
     - Directions API
     - Places API（必要な場合）
6. 作成したキーを以下の場所に反映:
   - HTML内のAPIキー部分すべて
   - JavaScriptのloadGoogleMapsApi関数内
*/
