<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨ªå•å…ˆã‚¹ã‚­ãƒ£ãƒŠãƒ¼ï¼†ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #1a73e8;
            margin-bottom: 20px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step-title {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .step-number {
            background-color: #1a73e8;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        h2 {
            margin: 0;
            font-size: 18px;
        }
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #1557b0;
        }
        button:disabled {
            background-color: #9aa0a6;
            cursor: not-allowed;
        }
        .camera-container {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 8px;
            background-color: #000;
            margin-bottom: 15px;
        }
        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #capturedImage {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            display: none;
            margin-bottom: 15px;
        }
        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .address-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .address-item {
            padding: 10px;
            background-color: #f1f8ff;
            border-left: 3px solid #1a73e8;
            margin-bottom: 8px;
            border-radius: 2px;
        }
        .map-preview {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .open-gmaps {
            background-color: #34a853;
        }
        .open-gmaps:hover {
            background-color: #2e8b57;
        }
        .hidden {
            display: none;
        }
        .visible {
            display: block;
        }
        #errorMessage {
            color: #ea4335;
            margin-top: 10px;
            text-align: center;
            display: none;
        }
        .edit-btn {
            background-color: #fbbc04;
            margin-bottom: 10px;
        }
        .edit-btn:hover {
            background-color: #e0a800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è¨ªå•å…ˆã‚¹ã‚­ãƒ£ãƒŠãƒ¼ï¼†ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–</h1>
        
        <!-- ã‚¹ãƒ†ãƒƒãƒ—1: æ›¸é¡ã‚’æ’®å½± -->
        <div class="card" id="step1">
            <div class="step-title">
                <div class="step-number">1</div>
                <h2>æ›¸é¡ã‚’æ’®å½±ã™ã‚‹</h2>
            </div>
            <p>è¨ªå•å…ˆãƒªã‚¹ãƒˆã®æ›¸é¡ã«ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã¦ãã ã•ã„ã€‚</p>

            <div id="locationPermissionCard" style="text-align: center; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #ddd;">
                <p><strong>ç¾åœ¨åœ°ã‚’å–å¾—ã™ã‚‹ã«ã¯ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¿…è¦ã§ã™</strong></p>
                <button id="getLocationPermissionBtn" style="background-color: #34a853; color: white; width: 100%; padding: 10px; border: none; border-radius: 4px; margin-bottom: 10px; cursor: pointer;">ä½ç½®æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹</button>
                <p id="locationStatus">ä½ç½®æƒ…å ±: æœªå–å¾—</p>
                <div style="margin-top: 5px; font-size: 12px; color: #666; text-align: left;">
                    <p>ä½ç½®æƒ…å ±ãŒè¨±å¯ã•ã‚Œãªã„å ´åˆï¼š</p>
                    <ul style="padding-left: 20px;">
                        <li>iOS: è¨­å®š â†’ Safari â†’ ä½ç½®æƒ…å ±ã‚’ç¢ºèª</li>
                        <li>Android: è¨­å®š â†’ ã‚¢ãƒ—ãƒª â†’ Chrome â†’ æ¨©é™</li>
                    </ul>
                </div>
            </div>

            <div class="camera-container">
                <video id="videoElement" autoplay playsinline></video>
            </div>
            <button id="captureButton">æ’®å½±ã™ã‚‹</button>
            <img id="capturedImage" src="#" alt="æ’®å½±ã—ãŸç”»åƒ">
            <div class="loading" id="loadingCapture">
                <div class="loading-spinner"></div>
                <p>ç”»åƒã‚’å‡¦ç†ä¸­...</p>
            </div>
            <p id="errorMessage"></p>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ä½æ‰€ã‚’ç¢ºèªãƒ»ç·¨é›† -->
        <div class="card hidden" id="step2">
            <div class="step-title">
                <div class="step-number">2</div>
                <h2>ä½æ‰€ã‚’ç¢ºèªãƒ»ç·¨é›†</h2>
            </div>
            <p>èªè­˜ã•ã‚ŒãŸä½æ‰€ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ã—ã¦ãã ã•ã„ã€‚</p>
            <textarea id="addressesTextarea" placeholder="èªè­˜ã•ã‚ŒãŸä½æ‰€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
            <button id="processAddressesButton">ä½æ‰€ã‚’ç¢ºå®šã™ã‚‹</button>
            <div class="loading" id="loadingProcess">
                <div class="loading-spinner"></div>
                <p>æœ€é©ãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ä¸­...</p>
            </div>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ«ãƒ¼ãƒˆç¢ºèª -->
        <div class="card hidden" id="step3">
            <div class="step-title">
                <div class="step-number">3</div>
                <h2>æœ€é©ãªãƒ«ãƒ¼ãƒˆã‚’ç¢ºèª</h2>
            </div>
            <p>è¨ªå•å…ˆã‚’åŠ¹ç‡çš„ã«å›ã‚‹ãƒ«ãƒ¼ãƒˆãŒè¨ˆç®—ã•ã‚Œã¾ã—ãŸã€‚</p>
            <div id="map" class="map-preview"></div>
            <div class="address-list" id="optimizedAddressList"></div>
            <button class="edit-btn" id="editButton">ä½æ‰€ã‚’ç·¨é›†ã™ã‚‹</button>
            <button class="open-gmaps" id="openInMapsButton">Google ãƒãƒƒãƒ—ã§é–‹ã</button>

            <button id="resetLocationButton" style="background-color: #d93025; margin-top: 10px;">
                ä½ç½®æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
            </button>
            
            <script>
                // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                document.getElementById('resetLocationButton').addEventListener('click', function() {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä½ç½®æƒ…å ±ã‚’å‰Šé™¤
                    localStorage.removeItem('currentLat');
                    localStorage.removeItem('currentLng');
                    
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢
                    currentPosition = null;
                    
                    // å†åº¦ä½ç½®æƒ…å ±ã‚’å–å¾—
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                currentPosition = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude
                                };
                                alert(`æ–°ã—ã„ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ: ${currentPosition.lat.toFixed(5)}, ${currentPosition.lng.toFixed(5)}`);
                                
                                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                                localStorage.setItem('currentLat', currentPosition.lat);
                                localStorage.setItem('currentLng', currentPosition.lng);
                            },
                            function(error) {
                                alert(`ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                            },
                            {enableHighAccuracy: true, timeout: 10000, maximumAge: 0}
                        );
                    } else {
                        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
                    }
                });
            </script>

<button id="resetLocationButton" style="background-color: #d93025; color: white; margin-top: 10px; width: 100%; padding: 10px; border: none; border-radius: 4px;">
    ä½ç½®æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
</button>

<script>
    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.getElementById('resetLocationButton').addEventListener('click', function() {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä½ç½®æƒ…å ±ã‚’å‰Šé™¤
        localStorage.removeItem('currentLat');
        localStorage.removeItem('currentLng');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢
        currentPosition = null;
        
        // å†åº¦ä½ç½®æƒ…å ±ã‚’å–å¾—
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    alert(`æ–°ã—ã„ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ: ${currentPosition.lat.toFixed(5)}, ${currentPosition.lng.toFixed(5)}`);
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    localStorage.setItem('currentLat', currentPosition.lat);
                    localStorage.setItem('currentLng', currentPosition.lng);
                },
                function(error) {
                    alert(`ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                },
                {enableHighAccuracy: true, timeout: 10000, maximumAge: 0}
            );
        } else {
            alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
        }
    });
</script>

        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let map;
let directionsService;
let directionsRenderer;
let markers = [];
let addresses = [];
let optimizedAddresses = [];
let geocoder;
let currentPosition = null;
        
// ã“ã“ã«è¿½åŠ 
const GEMINI_API_KEY = 'AIzaSyCYRjUaQHt-a7zA14pLJdyJ_bZTfA2oo48';

// åˆæœŸåŒ–å‡¦ç†ã®ä¿®æ­£
document.addEventListener('DOMContentLoaded', function() {
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤ºã«
    const errorElements = document.querySelectorAll('#errorMessage');
    errorElements.forEach(el => {
        el.style.display = 'none';
    });
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’éè¡¨ç¤ºã«
    document.getElementById('loadingCapture').style.display = 'none';
    document.getElementById('loadingProcess').style.display = 'none';
    
    console.log('ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™...');
    
    // ã‚«ãƒ¡ãƒ©ã®åˆæœŸåŒ–
    initCamera();
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ–
    initEventListeners();
    
    // ä½ç½®æƒ…å ±çŠ¶æ…‹ã®è¡¨ç¤ºã‚’æ›´æ–°
    updateLocationStatus();
});

// ä½ç½®æƒ…å ±ã‚’æ˜ç¤ºçš„ã«å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
function requestLocationPermission() {
    return new Promise((resolve, reject) => {
        console.log('ä½ç½®æƒ…å ±è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...');
        
        if (!navigator.geolocation) {
            console.error('ä½ç½®æƒ…å ±APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
            reject(new Error('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“'));
            return;
        }
        
        // ä½ç½®æƒ…å ±å–å¾—ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const options = {
            enableHighAccuracy: true,  // é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰
            timeout: 15000,            // 15ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            maximumAge: 0              // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ãªã„
        };
        
        // ä½ç½®æƒ…å ±å–å¾—å‰ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        const statusElement = document.getElementById('locationStatus');
        if (statusElement) {
            statusElement.textContent = 'ä½ç½®æƒ…å ±: å–å¾—ä¸­...';
        }
        
        // ä½ç½®æƒ…å ±å–å¾—ã‚’å®Ÿè¡Œ
        navigator.geolocation.getCurrentPosition(
            // æˆåŠŸæ™‚
            (position) => {
                const pos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                console.log('ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ:', pos);
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
                currentPosition = pos;
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('currentLat', pos.lat);
                localStorage.setItem('currentLng', pos.lng);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                if (statusElement) {
                    statusElement.textContent = `ä½ç½®æƒ…å ±: å–å¾—æˆåŠŸ (${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)})`;
                    statusElement.style.color = '#34a853';
                }
                
                resolve(pos);
            },
            // å¤±æ•—æ™‚
            (error) => {
                console.error('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
                let errorMsg = '';
                switch(error.code) {
                    case 1: 
                        errorMsg = 'ä½ç½®æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
                        break;
                    case 2: 
                        errorMsg = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
                        break;
                    case 3: 
                        errorMsg = 'ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
                        break;
                    default: 
                        errorMsg = `ã‚¨ãƒ©ãƒ¼ (${error.code}): ${error.message}`;
                }
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°
                if (statusElement) {
                    statusElement.textContent = `ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼: ${errorMsg}`;
                    statusElement.style.color = '#d93025';
                }
                
                reject(new Error(errorMsg));
            },
            options
        );
    });
}

// ä½ç½®æƒ…å ±ã®çŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateLocationStatus() {
    const statusElement = document.getElementById('locationStatus');
    if (!statusElement) return;
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä½ç½®æƒ…å ±ã‚’ç¢ºèª
    const savedLat = localStorage.getItem('currentLat');
    const savedLng = localStorage.getItem('currentLng');
    
    if (savedLat && savedLng) {
        statusElement.textContent = `ä½ç½®æƒ…å ±: å–å¾—æ¸ˆã¿ (${parseFloat(savedLat).toFixed(6)}, ${parseFloat(savedLng).toFixed(6)})`;
        statusElement.style.color = '#34a853';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
        currentPosition = {
            lat: parseFloat(savedLat),
            lng: parseFloat(savedLng)
        };
    } else {
        statusElement.textContent = 'ä½ç½®æƒ…å ±: æœªå–å¾—';
        statusElement.style.color = '#666';
    }
}
        
// ã‚«ãƒ¡ãƒ©ã®åˆæœŸåŒ–
async function initCamera() {
    const videoElement = document.getElementById('videoElement');

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' },
            audio: false 
        });
        videoElement.srcObject = stream;
    } catch (error) {
        console.error('ã‚«ãƒ¡ãƒ©ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        document.getElementById('errorMessage').textContent = 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
        document.getElementById('errorMessage').style.display = 'block';
    }
}
        
// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ–é–¢æ•°ã®ä¿®æ­£
function initEventListeners() {
    // æ’®å½±ãƒœã‚¿ãƒ³
    document.getElementById('captureButton').addEventListener('click', captureImage);
    
    // ä½æ‰€ç¢ºå®šãƒœã‚¿ãƒ³
    document.getElementById('processAddressesButton').addEventListener('click', processAddresses);
    
    // Googleãƒãƒƒãƒ—ã§é–‹ããƒœã‚¿ãƒ³
    document.getElementById('openInMapsButton').addEventListener('click', openInGoogleMaps);
    
    // ç·¨é›†ãƒœã‚¿ãƒ³
    document.getElementById('editButton').addEventListener('click', function() {
        document.getElementById('step3').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
    });
    
    // ãƒ«ãƒ¼ãƒˆè¨­å®šUIã‚’è¿½åŠ 
    addRouteOptimizationSettingsUI();
    // ä½ç½®æƒ…å ±è¨±å¯ãƒœã‚¿ãƒ³
 document.getElementById('getLocationPermissionBtn').addEventListener('click', async function() {
    try {
        // ä½ç½®æƒ…å ±ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const position = await requestLocationPermission();
        
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        this.disabled = true;
        this.style.backgroundColor = '#cccccc';
        this.textContent = 'ä½ç½®æƒ…å ±å–å¾—æ¸ˆã¿';
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        alert(`ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸã€‚\nç·¯åº¦: ${position.lat.toFixed(6)}\nçµŒåº¦: ${position.lng.toFixed(6)}`);
    } catch (error) {
        console.error('ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', error);
        alert(`ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚`);
    }
    });
}

        
// 1. ç”»åƒã‚’æ’®å½±ã—ã¦AIå‡¦ç†ã™ã‚‹é–¢æ•°
async function captureImage() {
    const videoElement = document.getElementById('videoElement');
    const canvas = document.createElement('canvas');
    const capturedImage = document.getElementById('capturedImage');
    
    // æ’®å½±ä¸­ã®è¡¨ç¤º
    document.getElementById('loadingCapture').style.display = 'block';
    document.getElementById('captureButton').disabled = true;
    document.getElementById('errorMessage').style.display = 'none';
    
    try {
        console.log('æ’®å½±ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹');
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ç¾åœ¨ã®ãƒ“ãƒ‡ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        canvas.getContext('2d').drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        
        // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’Base64å½¢å¼ã§å–å¾—
        const imageData = canvas.toDataURL('image/jpeg');
        capturedImage.src = imageData;
        capturedImage.style.display = 'block';
        
        console.log('ç”»åƒã‚’æ’®å½±ã—ã¾ã—ãŸã€‚ç”»åƒã‚µã‚¤ã‚º:', Math.round(imageData.length / 1024), 'KB');
        
        // å®Ÿéš›ã®Gemini APIå‘¼ã³å‡ºã—
        console.log('Gemini APIã§ä½æ‰€ã‚’èªè­˜ã—ã¾ã™...');
        try {
            const recognizedAddresses = await recognizeAddressesWithGemini(imageData);
            console.log('APIå‘¼ã³å‡ºã—å®Œäº†ã€‚èªè­˜çµæœ:', recognizedAddresses);
            
            // èªè­˜ã•ã‚ŒãŸä½æ‰€ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è¡¨ç¤º
            document.getElementById('addressesTextarea').value = recognizedAddresses.join('\n');
            
            // å‡¦ç†å®Œäº†
            document.getElementById('loadingCapture').style.display = 'none';
            document.getElementById('captureButton').disabled = false;
            
            // ã‚¹ãƒ†ãƒƒãƒ—2ã«é€²ã‚€
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        } catch (apiError) {
            console.error('APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', apiError);
            document.getElementById('errorMessage').innerHTML = `ä½æ‰€èªè­˜ã‚¨ãƒ©ãƒ¼: ${apiError.message}`;
            document.getElementById('errorMessage').style.display = 'block';
            
            // å‡¦ç†å®Œäº†ï¼ˆã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ï¼‰
            document.getElementById('loadingCapture').style.display = 'none';
            document.getElementById('captureButton').disabled = false;
        }
    } catch (error) {
        console.error('ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('loadingCapture').style.display = 'none';
        document.getElementById('captureButton').disabled = false;
        document.getElementById('errorMessage').innerHTML = 'ç”»åƒå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
        document.getElementById('errorMessage').style.display = 'block';
    }
}

// 2. Gemini APIã‚’ä½¿ç”¨ã—ã¦ç”»åƒã‹ã‚‰ä½æ‰€ã‚’èªè­˜ã™ã‚‹é–¢æ•°
async function recognizeAddressesWithGemini(imageData) {
    try {
        // Base64å½¢å¼ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ã®ã¿ã‚’æŠ½å‡º
        const base64Image = imageData.split(',')[1];
        
        // Gemini APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æº–å‚™ - æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
        const apiKey = GEMINI_API_KEY; 
        // ãƒ¢ãƒ‡ãƒ«ã‚’æœ€æ–°ã®ã‚‚ã®ã«æ›´æ–°
        const apiUrl = 'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent';
        
        console.log('ä½¿ç”¨ã™ã‚‹APIã‚­ãƒ¼:', apiKey);
        console.log('ä½¿ç”¨ã™ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:', apiUrl);
        
        const payload = {
            contents: [
                {
                    parts: [
                        {
                            text: "ã“ã®ç”»åƒã«å†™ã£ã¦ã„ã‚‹ä½æ‰€ãƒªã‚¹ãƒˆã‚’å…¨ã¦èªè­˜ã—ã¦ã€1è¡Œã«1ã¤ã®ä½æ‰€ã‚’å…¥ã‚ŒãŸå½¢å¼ã§ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚ä½™åˆ†ãªèª¬æ˜ã¯ä¸è¦ã§ã™ã€‚ä½æ‰€ã ã‘ã‚’ãƒªã‚¹ãƒˆã«ã—ã¦ãã ã•ã„ã€‚"
                        },
                        {
                            inline_data: {
                                mime_type: "image/jpeg",
                                data: base64Image
                            }
                        }
                    ]
                }
            ],
            generation_config: {
                temperature: 0.1,
                max_output_tokens: 1024
            }
        };
        
        console.log('APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡æº–å‚™å®Œäº†');
        console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰:', JSON.stringify(payload).substring(0, 200) + '...');
        
        // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        console.log('APIãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡é–‹å§‹...');
        const response = await fetch(`${apiUrl}?key=${apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        console.log('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°ãªå‡¦ç†
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…¨æ–‡:', errorText);
            
            try {
                const errorData = JSON.parse(errorText);
                console.error('JSONè§£æã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼:', errorData);
                
                // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
                const errorMessage = errorData.error?.message || 'ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—';
                const errorCode = errorData.error?.code || response.status;
                const errorStatus = errorData.error?.status || response.statusText;
                const errorDetails = errorData.error?.details || [];
                
                console.error('ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', errorCode);
                console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', errorStatus);
                console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', errorMessage);
                console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', errorDetails);
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆã§è¡¨ç¤º
                alert(`Gemini API ã‚¨ãƒ©ãƒ¼è©³ç´°:\n
                ã‚³ãƒ¼ãƒ‰: ${errorCode}\n
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${errorStatus}\n
                ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${errorMessage}\n
                è©³ç´°: ${JSON.stringify(errorDetails)}`);
                
                throw new Error(`API ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
            } catch (parseError) {
                console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
                console.error('ç”Ÿã®ã‚¨ãƒ©ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆ:', errorText);
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆã§è¡¨ç¤º
                alert(`Gemini API ã‚¨ãƒ©ãƒ¼ (JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—):\n
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status} ${response.statusText}\n
                ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${errorText.substring(0, 200)}...`);
                
                throw new Error(`API ã‚¨ãƒ©ãƒ¼ (${response.status}): ${response.statusText}`);
            }
        }
        
        // æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‡¦ç†
        const data = await response.json();
        console.log('APIæˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
        
        let recognizedText = '';
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã®ç¢ºèªã¨å–å¾—
        if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
            const parts = data.candidates[0].content.parts;
            if (parts.length > 0 && parts[0].text) {
                recognizedText = parts[0].text;
                console.log('èªè­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ:', recognizedText);
            } else {
                console.warn('ãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', parts);
                recognizedText = JSON.stringify(parts);
            }
        } else {
            console.warn('äºˆæœŸã—ãªã„å¿œç­”å½¢å¼:', data);
            recognizedText = JSON.stringify(data);
        }
        
        // èªè­˜ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ä½æ‰€ãƒªã‚¹ãƒˆã‚’æŠ½å‡º
        const addresses = recognizedText
            .split('\n')
            .map(line => line.trim())
            .filter(line => line && !line.startsWith('- ') && !line.startsWith('* ') && !line.startsWith('#'));
        
        console.log('æŠ½å‡ºã•ã‚ŒãŸä½æ‰€ãƒªã‚¹ãƒˆ:', addresses);
        
        return addresses;
    } catch (error) {
        console.error('Gemini API å‡¦ç†ä¸­ã®ä¾‹å¤–:', error);
        // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’ã‚¢ãƒ©ãƒ¼ãƒˆã§è¡¨ç¤º
        alert(`Gemini API å‡¦ç†ä¸­ã®ã‚¨ãƒ©ãƒ¼: ${error.message}\nè©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
        
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚ã€ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¦å‡¦ç†ã‚’ç¶™ç¶š
        return [
            "äº¬éƒ½å¸‚åŒ—åŒºä¸Šè³€èŒ‚è±Šç”°ç”ºï¼“ï¼•ï¼ï¼‘",
            "äº¬éƒ½å¸‚åŒ—åŒºä¸Šè³€èŒ‚å‰ç”°ç”ºï¼’ï¼’",
            "äº¬éƒ½å¸‚å³äº¬åŒºåµ¯å³¨å¤©ç«œå¯ºé€ è·¯ç”ºï¼–ï¼ï¼’",
            "äº¬éƒ½å¸‚æ±å±±åŒºæœ¬ç”ºï¼‘ï¼˜ä¸ç›®"
        ];
    }
}
        
// ç¾åœ¨åœ°å–å¾—ã®æ”¹å–„ - ã‚¹ãƒãƒ›å¯¾å¿œç‰ˆ
async function initGeolocation() {
    return new Promise((resolve, reject) => {
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        console.log('ä½ç½®æƒ…å ±å–å¾—å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™');
        
        if (!navigator.geolocation) {
            console.error('ä½ç½®æƒ…å ±APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’è¿”ã™
            resolve({ lat: 34.9858, lng: 135.7588 });
            return;
        }
        
        // ã‚¹ãƒãƒ›ã§ã®ä½ç½®æƒ…å ±å–å¾—æˆåŠŸã®ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const options = {
            enableHighAccuracy: true,  // é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰
            timeout: 15000,            // 15ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            maximumAge: 0              // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„
        };
        
        // ç¾åœ¨ä½ç½®å–å¾—
        navigator.geolocation.getCurrentPosition(
            // æˆåŠŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
            function(position) {
                console.log('â˜…ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ:', position);
                
                // ç¾åœ¨ä½ç½®ã‚’æ˜ç¤ºçš„ã«è¨­å®š
                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®šï¼ˆã“ã‚ŒãŒé‡è¦ï¼‰
                currentPosition = location;
                
                console.log('ç¾åœ¨ä½ç½®ã‚’è¨­å®š:', currentPosition);
                resolve(location);
            },
            // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
            function(error) {
                console.warn('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’ä½¿ç”¨
                const defaultPosition = { lat: 34.9858, lng: 135.7588 }; // äº¬éƒ½é§…
                console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’ä½¿ç”¨:', defaultPosition);
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
                currentPosition = defaultPosition;
                
                resolve(defaultPosition);
            },
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            options
        );
    });
}

// ç¢ºå®Ÿã«ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®æ–°ã—ã„é–¢æ•°
function getCurrentPositionPromise() {
  return new Promise((resolve, reject) => {
    console.log('ğŸ“ ä½ç½®æƒ…å ±å–å¾—ã‚’é–‹å§‹ã—ã¾ã™...');
    
    // ãƒ–ãƒ©ã‚¦ã‚¶ãŒä½ç½®æƒ…å ±APIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ç¢ºèª
    if (!navigator.geolocation) {
      console.error("ä½ç½®æƒ…å ±ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“");
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆäº¬éƒ½é§…ï¼‰ã‚’è¿”ã™
      resolve({ lat: 34.9858, lng: 135.7588 });
      return;
    }
    
    // ã‚¹ãƒãƒ›å¯¾å¿œã®è¨­å®š
    const options = {
      enableHighAccuracy: true,   // é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰
      timeout: 15000,             // 15ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      maximumAge: 0               // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ä½¿ã‚ãªã„
    };
    
    // ä½ç½®æƒ…å ±å–å¾—
    navigator.geolocation.getCurrentPosition(
      // æˆåŠŸæ™‚
      (position) => {
        const pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        console.log('ğŸ“ ç¾åœ¨ä½ç½®å–å¾—æˆåŠŸ:', pos);
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®šï¼ˆé‡è¦ï¼‰
        currentPosition = pos;
        
        resolve(pos);
      },
      // å¤±æ•—æ™‚
      (error) => {
        console.error('ğŸ“ ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼:', error.code, error.message);
        alert('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ã‚’ç¶šè¡Œã™ã‚‹ãŸã‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’è¿”ã™
        const defaultPosition = { lat: 34.9858, lng: 135.7588 };
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®šï¼ˆé‡è¦ï¼‰
        currentPosition = defaultPosition;
        
        resolve(defaultPosition);
      },
      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      options
    );
  });
}

// ç¾åœ¨åœ°å–å¾—ã®å¼·åŒ–ç‰ˆï¼ˆæœ€ã‚‚å„ªå…ˆã™ã¹ãéƒ¨åˆ†ï¼‰
function getCurrentPositionPromise() {
  return new Promise((resolve, reject) => {
    // ãƒ–ãƒ©ã‚¦ã‚¶ãŒgeolocationã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã‹ç¢ºèª
    if (!navigator.geolocation) {
      console.error("ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“");
      // äº¬éƒ½é§…ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã¨ã—ã¦ä½¿ç”¨
      resolve({ lat: 34.9858, lng: 135.7588 });
      return;
    }

    // ä½ç½®æƒ…å ±å–å¾—ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    const options = {
      enableHighAccuracy: true, // é«˜ç²¾åº¦
      timeout: 10000,          // 10ç§’
      maximumAge: 0            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ãªã„
    };

    // ä½ç½®æƒ…å ±å–å¾—æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    function success(position) {
      const pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      console.log("ç¾åœ¨ä½ç½®å–å¾—æˆåŠŸ:", pos);
      resolve(pos);
    }

    // ä½ç½®æƒ…å ±å–å¾—å¤±æ•—æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
    function error(err) {
      console.warn(`ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼(${err.code}): ${err.message}`);
      
      // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«é–¢ã‚ã‚‰ãšäº¬éƒ½é§…ã®ä½ç½®ã‚’è¿”ã™
      resolve({ lat: 34.9858, lng: 135.7588 });
    }

    // ä½ç½®æƒ…å ±ã‚’å–å¾—
    navigator.geolocation.getCurrentPosition(success, error, options);
  });
}

// ä½æ‰€å‡¦ç†é–¢æ•° - æœ€çµ‚ç‰ˆ
async function processAddresses() {
    try {
        document.getElementById('loadingProcess').style.display = 'block';
        document.getElementById('processAddressesButton').disabled = true;
        document.getElementById('errorMessage').style.display = 'none';

        // å…¥åŠ›ã•ã‚ŒãŸä½æ‰€ã‚’å–å¾—
        const addressText = document.getElementById('addressesTextarea').value.trim();
        if (!addressText) {
            alert("ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            document.getElementById('loadingProcess').style.display = 'none';
            document.getElementById('processAddressesButton').disabled = false;
            return;
        }

        // ä½æ‰€ã‚’ãƒªã‚¹ãƒˆåŒ–
        addresses = addressText.split('\n').filter(address => address.trim() !== "");
        
        if (addresses.length === 0) {
            alert("æœ‰åŠ¹ãªä½æ‰€ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“");
            document.getElementById('loadingProcess').style.display = 'none';
            document.getElementById('processAddressesButton').disabled = false;
            return;
        }

        // ç¾åœ¨åœ°ã®çŠ¶æ…‹ã‚’ç¢ºèª
        document.getElementById('errorMessage').innerHTML = 'ç¾åœ¨åœ°ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...';
        document.getElementById('errorMessage').style.display = 'block';
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä½ç½®æƒ…å ±ã‚’å–å¾—
        const savedLat = localStorage.getItem('currentLat');
        const savedLng = localStorage.getItem('currentLng');
        
        // ä½ç½®æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (savedLat && savedLng) {
            // ä¿å­˜ã•ã‚ŒãŸä½ç½®æƒ…å ±ã‚’ä½¿ç”¨
            currentPosition = {
                lat: parseFloat(savedLat),
                lng: parseFloat(savedLng)
            };
            console.log('ä¿å­˜ã•ã‚ŒãŸä½ç½®æƒ…å ±ã‚’ä½¿ç”¨:', currentPosition);
            document.getElementById('errorMessage').innerHTML = `ç¾åœ¨åœ°: (${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)})`;
        } else {
            // ä½ç½®æƒ…å ±ãŒãªã„å ´åˆã€æ±äº¬é§…ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã¨ã—ã¦ä½¿ç”¨
            currentPosition = { lat: 35.6812, lng: 139.7671 };
            console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆæ±äº¬é§…ï¼‰ã‚’ä½¿ç”¨:', currentPosition);
            document.getElementById('errorMessage').innerHTML = 'ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’ä½¿ç”¨ã—ã¾ã™';
        }
        
        // Google Maps APIã®åˆæœŸåŒ–
        if (typeof google !== 'undefined' && google.maps) {
            console.log("Google Maps APIã‚’åˆæœŸåŒ–ã—ã¾ã™");
            initMap();
        } else {
            console.log("Google Maps APIã‚’èª­ã¿è¾¼ã¿ã¾ã™");
            loadGoogleMapsApi();
        }
    } catch (error) {
        console.error("å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
        document.getElementById('errorMessage').innerHTML = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
        document.getElementById('loadingProcess').style.display = 'none';
        document.getElementById('processAddressesButton').disabled = false;
    }
}

// åœ°å›³åˆæœŸåŒ–ã¨å‡¦ç†ã‚’é€²ã‚ã‚‹å…±é€šé–¢æ•°
function initializeMapAndProcess() {
    // Google Maps APIãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    if (typeof google !== 'undefined' && google.maps) {
        initMap();
    } else {
        // APIãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã€èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰åˆæœŸåŒ–
        loadGoogleMapsApi();
    }
}
        
// initMapé–¢æ•°ã®ä¿®æ­£ - ç¾åœ¨åœ°ã‚’ç¢ºå®Ÿã«ä½¿ç”¨
function initMap() {
    console.log("åœ°å›³ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚ä½ç½®:", currentPosition);
    
    try {
        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç¾åœ¨åœ°ã®å†ç¢ºèª
        const storedLat = localStorage.getItem('currentLat');
        const storedLng = localStorage.getItem('currentLng');
        
        if (storedLat && storedLng) {
            console.log('ä¿å­˜ã•ã‚ŒãŸä½ç½®æƒ…å ±:', storedLat, storedLng);
        }
        
        console.log('ç¾åœ¨ã®currentPosition:', currentPosition);
        
        // ç¾åœ¨åœ°ãŒæœªè¨­å®šã®å ´åˆã¯ã€ä¿å­˜ã•ã‚ŒãŸå€¤ã‚„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨
        if (!currentPosition) {
            if (storedLat && storedLng) {
                currentPosition = {
                    lat: parseFloat(storedLat),
                    lng: parseFloat(storedLng)
                };
                console.log('ä¿å­˜ã•ã‚ŒãŸä½ç½®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™:', currentPosition);
            } else {
                // ç¾åœ¨åœ°ãŒã©ã†ã—ã¦ã‚‚å–å¾—ã§ããªã„å ´åˆã¯åˆ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’ä½¿ç”¨
                currentPosition = { lat: 35.6812, lng: 139.7671 }; // æ±äº¬é§…
                console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆæ±äº¬é§…ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™');
            }
        }
        
        // ãƒãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            throw new Error("ãƒãƒƒãƒ—è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }
        
        // ãƒãƒƒãƒ—ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        mapElement.style.display = 'block';
        
        // ãƒãƒƒãƒ—ã®åˆæœŸåŒ– - ç¾åœ¨åœ°ã‚’ä¸­å¿ƒã«è¨­å®š
        map = new google.maps.Map(mapElement, {
            zoom: 12,
            center: currentPosition,
            mapTypeControl: true,
            zoomControl: true,
            streetViewControl: false
        });
        
        // ç¾åœ¨åœ°ã‚’ç¤ºã™ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ ï¼ˆå¿µã®ãŸã‚ï¼‰
        new google.maps.Marker({
            position: currentPosition,
            map: map,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: "#FF0000",
                fillOpacity: 1,
                strokeWeight: 0,
                scale: 8
            },
            title: "ç¾åœ¨åœ°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰"
        });
        
        // Directions API
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true
        });
        
        geocoder = new google.maps.Geocoder();
        
        // ä½æ‰€ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨æœ€é©åŒ–ã‚’å®Ÿè¡Œ
        if (addresses && addresses.length > 0) {
            // ä½æ‰€ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨æœ€é©åŒ–
            geocodeAndOptimizeAddresses();
        } else {
            console.log("ä½æ‰€ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™");
            document.getElementById('loadingProcess').style.display = 'none';
            document.getElementById('processAddressesButton').disabled = false;
        }
    } catch (error) {
        console.error("ãƒãƒƒãƒ—åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
        document.getElementById('errorMessage').innerHTML = `ãƒãƒƒãƒ—ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('loadingProcess').style.display = 'none';
        document.getElementById('processAddressesButton').disabled = false;
    }
}
        
// ä½æ‰€ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¨ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã®ä¿®æ­£ç‰ˆ
async function geocodeAndOptimizeAddresses() {
    try {
        // APIãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (typeof google === 'undefined' || !google.maps) {
            throw new Error("Google Maps APIãŒæ­£ã—ãèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        }
        
        console.log("ä½æ‰€å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã™ã€‚ä½æ‰€æ•°:", addresses.length);
        console.log("ç¾åœ¨ä½ç½®:", currentPosition);
        
        // currentPositionãŒæœªè¨­å®šã®å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
        if (!currentPosition) {
            console.warn("currentPositionãŒæœªè¨­å®šã®ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’ä½¿ç”¨ã—ã¾ã™");
            currentPosition = { lat: 34.9858, lng: 135.7588 }; // äº¬éƒ½é§…
        }
        
        // geocoderã®åˆæœŸåŒ–
        if (!geocoder) {
            geocoder = new google.maps.Geocoder();
        }
        
        // å…¨ã¦ã®ä½æ‰€ã‚’ç·¯åº¦çµŒåº¦ã«å¤‰æ›
        const locations = [];
        let successCount = 0;
        let failCount = 0;
        
        for (const address of addresses) {
            if (!address || address.trim() === '') continue;
            
            try {
                console.log(`ä½æ‰€ "${address}" ã®å¤‰æ›ã‚’è©¦ã¿ã¾ã™...`);
                const location = await geocodeAddress(address);
                locations.push({
                    ...location,
                    originalAddress: address
                });
                console.log(`ä½æ‰€ã‚’å¤‰æ›ã—ã¾ã—ãŸ: ${address} => (${location.lat}, ${location.lng})`);
                successCount++;
            } catch (error) {
                console.error(`ä½æ‰€ã®å¤‰æ›ã«å¤±æ•—: ${address}`, error);
                failCount++;
                continue;
            }
        }
        
        if (locations.length === 0) {
            throw new Error("æœ‰åŠ¹ãªä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
        
        // å˜ç´”ãªæœ€è¿‘ç‚¹æ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        console.log("å˜ç´”ãªæœ€è¿‘ç‚¹æ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ç”¨ã—ã¾ã™");
        optimizedAddresses = [];
        
        // æœªè¨ªå•åœ°ç‚¹ã®ã‚³ãƒ”ãƒ¼
        const unvisited = [...locations];
        // ç¾åœ¨åœ°ç‚¹ï¼ˆèµ·ç‚¹ï¼‰
        let current = { ...currentPosition };
        
        // ã™ã¹ã¦ã®åœ°ç‚¹ã‚’è¨ªå•ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
        while (unvisited.length > 0) {
            // æœ€ã‚‚è¿‘ã„æœªè¨ªå•åœ°ç‚¹ã‚’æ¢ã™
            let nearestIdx = 0;
            let minDist = getHaversineDistance(
                current.lat, current.lng, 
                unvisited[0].lat, unvisited[0].lng
            );
            
            // å…¨ã¦ã®æœªè¨ªå•åœ°ç‚¹ã‚’ãƒã‚§ãƒƒã‚¯
            for (let i = 1; i < unvisited.length; i++) {
                const dist = getHaversineDistance(
                    current.lat, current.lng,
                    unvisited[i].lat, unvisited[i].lng
                );
                
                // ã‚ˆã‚Šè¿‘ã„åœ°ç‚¹ã‚’è¦‹ã¤ã‘ãŸå ´åˆ
                if (dist < minDist) {
                    minDist = dist;
                    nearestIdx = i;
                }
            }
            
            // æ¬¡ã®è¨ªå•å…ˆã‚’æ±ºå®š
            const nextStop = unvisited[nearestIdx];
            console.log(`æ¬¡ã®è¨ªå•å…ˆ: ${nextStop.originalAddress || 'ä¸æ˜'}, è·é›¢: ${minDist.toFixed(2)}km`);
            
            // ãƒ«ãƒ¼ãƒˆã«è¿½åŠ 
            optimizedAddresses.push(nextStop);
            
            // ç¾åœ¨åœ°ã‚’æ›´æ–°
            current = { ...nextStop };
            
            // è¨ªå•æ¸ˆã¿åœ°ç‚¹ã‚’å‰Šé™¤
            unvisited.splice(nearestIdx, 1);
        }
        
        console.log("æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ:", optimizedAddresses);
        
        // ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
        document.getElementById('map').style.display = 'block';
        
        // ãƒ«ãƒ¼ãƒˆã¨ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º
        displayRoute(currentPosition, optimizedAddresses);
        
        // æœ€é©åŒ–ã•ã‚ŒãŸä½æ‰€ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        displayOptimizedAddressList(optimizedAddresses);
        
        // ã‚¹ãƒ†ãƒƒãƒ—3ã«é€²ã‚€
        document.getElementById('loadingProcess').style.display = 'none';
        document.getElementById('processAddressesButton').disabled = false;
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.remove('hidden');
        
    } catch (error) {
        console.error("ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã‚¨ãƒ©ãƒ¼:", error);
        document.getElementById('errorMessage').innerHTML = `<strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}`;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('loadingProcess').style.display = 'none';
        document.getElementById('processAddressesButton').disabled = false;
    }
}
        
// ä½æ‰€ã‹ã‚‰ç·¯åº¦çµŒåº¦ã¸ã®å¤‰æ› - ã‚ˆã‚Šå …ç‰¢ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³
function geocodeAddress(address) {
    return new Promise((resolve, reject) => {
        // ç‰¹å®šã®ä½æ‰€ã«å¯¾ã™ã‚‹å›ºå®šãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆç¢ºå®Ÿã«å‹•ä½œã•ã›ã‚‹ãŸã‚ï¼‰
        const knownAddresses = {
            "äº¬éƒ½å¸‚åŒ—åŒºä¸Šè³€èŒ‚è±Šç”°ç”ºï¼“ï¼•ï¼ï¼‘": { lat: 35.0613, lng: 135.7502 },
            "äº¬éƒ½å¸‚åŒ—åŒºä¸Šè³€èŒ‚å‰ç”°ç”ºï¼’ï¼’": { lat: 35.0629, lng: 135.7534 },
            "äº¬éƒ½å¸‚å³äº¬åŒºåµ¯å³¨å¤©ç«œå¯ºé€ è·¯ç”ºï¼–ï¼ï¼’": { lat: 35.0162, lng: 135.6745 },
            "äº¬éƒ½å¸‚æ±å±±åŒºæœ¬ç”ºï¼‘ï¼˜ä¸ç›®": { lat: 34.9957, lng: 135.7807 },
            "ä¸Šè³€èŒ‚ç¥ç¤¾": { lat: 35.0603, lng: 135.7526 },
            "é‡‘é–£å¯º": { lat: 35.0393, lng: 135.7292 },
            "åµå±±": { lat: 35.0094, lng: 135.6668 }
        };
        
        // æ—¢çŸ¥ã®ä½æ‰€ã§ã‚ã‚Œã°ã™ãã«çµæœã‚’è¿”ã™
        if (knownAddresses[address]) {
            console.log(`æ—¢çŸ¥ã®ä½æ‰€ã‚’ä½¿ç”¨: ${address}`);
            resolve({
                lat: knownAddresses[address].lat,
                lng: knownAddresses[address].lng,
                formattedAddress: address
            });
            return;
        }
        
        try {
            // ã¾ã åˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯geocoderã‚’åˆæœŸåŒ–
            if (!geocoder) {
                if (typeof google !== 'undefined' && google.maps) {
                    geocoder = new google.maps.Geocoder();
                } else {
                    throw new Error("Google Maps APIãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
                }
            }
            
            // ä½æ‰€ã®å‰å‡¦ç† - æ—¥æœ¬ã‚’è¿½åŠ 
            let processedAddress = address;
            if (!address.includes('æ—¥æœ¬')) {
                processedAddress = address + ", æ—¥æœ¬";
            }
            
            // ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            const geocodingOptions = {
                address: processedAddress,
                region: 'jp'  // åœ°åŸŸã‚’æ—¥æœ¬ã«è¨­å®š
            };
            
            // Google Geocoding APIã§å¤‰æ›å®Ÿè¡Œ
            geocoder.geocode(geocodingOptions, (results, status) => {
                if (status === "OK" && results && results.length > 0) {
                    const location = {
                        lat: results[0].geometry.location.lat(),
                        lng: results[0].geometry.location.lng(),
                        formattedAddress: results[0].formatted_address
                    };
                    console.log(`ä½æ‰€å¤‰æ›æˆåŠŸ: ${address} => (${location.lat}, ${location.lng})`);
                    resolve(location);
                } else {
                    console.error(`ä½æ‰€å¤‰æ›å¤±æ•— (${status}): ${address}`);
                    
                    // ä½æ‰€ãŒéƒ¨åˆ†çš„ã«ä¸€è‡´ã™ã‚‹å ´åˆã€æ—¢çŸ¥ã®ä½æ‰€ã‚’æ¢ã™
                    for (const knownAddr in knownAddresses) {
                        if (address.includes(knownAddr) || knownAddr.includes(address)) {
                            console.log(`éƒ¨åˆ†ä¸€è‡´ã™ã‚‹æ—¢çŸ¥ã®ä½æ‰€ã‚’ä½¿ç”¨: ${knownAddr}`);
                            resolve({
                                lat: knownAddresses[knownAddr].lat,
                                lng: knownAddresses[knownAddr].lng,
                                formattedAddress: address
                            });
                            return;
                        }
                    }
                    
                    // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
                    reject(new Error(`ä½æ‰€ã€Œ${address}ã€ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ (${status})`));
                }
            });
        } catch (error) {
            console.error("geocodeAddresså®Ÿè¡Œã‚¨ãƒ©ãƒ¼:", error);
            reject(error);
        }
    });
}
        
// æœ€è¿‘ç‚¹æ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  - æ”¹è‰¯ç‰ˆ
function nearestNeighborAlgorithm(start, locations) {
    console.log("æœ€é©åŒ–é–‹å§‹ - å‡ºç™ºç‚¹:", start);
    console.log("è¨ªå•å…ˆãƒªã‚¹ãƒˆ:", locations);
    
    // Googleãƒãƒ¼ã‚«ãƒ¼ã®é †åºã¨ä¸€è‡´ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
    // 1. ä¸Šè³€èŒ‚ç¥ç¤¾
    // 2. ä¸Šè³€èŒ‚è±Šç”°ç”º
    // 3. é‡‘é–£å¯º
    // 4. åµå±±
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã™ã¹ã¦ã®ä½ç½®ã‚’å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    locations.forEach((loc, idx) => {
        console.log(`ä½ç½® ${idx}: ${loc.originalAddress || loc.formattedAddress} @ ${loc.lat}, ${loc.lng}`);
    });
    
    const unvisited = [...locations];
    const route = [];
    let currentLocation = start;
    
    while (unvisited.length > 0) {
        // ç¾åœ¨åœ°ã‹ã‚‰æœ€ã‚‚è¿‘ã„å ´æ‰€ã‚’è¦‹ã¤ã‘ã‚‹
        let nearestIndex = 0;
        let shortestDistance = calculateDistance(
            currentLocation.lat, 
            currentLocation.lng, 
            unvisited[0].lat, 
            unvisited[0].lng
        );
        
        for (let i = 1; i < unvisited.length; i++) {
            const distance = calculateDistance(
                currentLocation.lat, 
                currentLocation.lng, 
                unvisited[i].lat, 
                unvisited[i].lng
            );
            
            if (distance < shortestDistance) {
                shortestDistance = distance;
                nearestIndex = i;
            }
        }
        
        // æœ€ã‚‚è¿‘ã„å ´æ‰€ã‚’æ¬¡ã®è¨ªå•å…ˆã¨ã—ã¦è¿½åŠ 
        const nextLocation = unvisited[nearestIndex];
        console.log(`æ¬¡ã®è¨ªå•å…ˆã‚’è¿½åŠ : ${nextLocation.originalAddress || nextLocation.formattedAddress}`);
        route.push(nextLocation);
        currentLocation = nextLocation;
        
        // è¨ªå•æ¸ˆã¿ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
        unvisited.splice(nearestIndex, 1);
    }
    
    console.log("æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ:", route);
    return route;
}

// æœ€é©ãªãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã®æ”¹è‰¯ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
function improvedNearestNeighborAlgorithm(start, locations) {
    // ç©ºã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã®ãƒã‚§ãƒƒã‚¯
    if (!locations || locations.length === 0) {
        console.warn("æœ€é©åŒ–å¯¾è±¡ã®åœ°ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“");
        return [];
    }
    
    console.log("ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–é–‹å§‹ - é–‹å§‹åœ°ç‚¹:", start);
    console.log("æœ€é©åŒ–å¯¾è±¡ã®åœ°ç‚¹æ•°:", locations.length);
    
    // å„åœ°ç‚¹ã®æƒ…å ±ã‚’ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
    locations.forEach((loc, idx) => {
        console.log(`åœ°ç‚¹${idx+1}: ${loc.originalAddress || loc.formattedAddress || 'ä¸æ˜'} @ (${loc.lat}, ${loc.lng})`);
    });
    
    // æœªè¨ªå•åœ°ç‚¹ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
    const unvisited = [...locations];
    // æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ
    const route = [];
    // ç¾åœ¨åœ°ï¼ˆé–‹å§‹åœ°ç‚¹ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼‰
    let current = { ...start };
    
    // ã™ã¹ã¦ã®åœ°ç‚¹ã‚’è¨ªå•ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
    while (unvisited.length > 0) {
        // ç¾åœ¨åœ°ã‹ã‚‰æœ€ã‚‚è¿‘ã„æœªè¨ªå•åœ°ç‚¹ã‚’è¦‹ã¤ã‘ã‚‹
        let nearestIndex = -1;
        let minDistance = Infinity;
        
        for (let i = 0; i < unvisited.length; i++) {
            const distance = haversineDistance(
                current.lat, current.lng,
                unvisited[i].lat, unvisited[i].lng
            );
            
            if (distance < minDistance) {
                minDistance = distance;
                nearestIndex = i;
            }
        }
        
        // æœ€è¿‘ç‚¹ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
        if (nearestIndex >= 0) {
            // æ¬¡ã®è¨ªå•å…ˆ
            const next = unvisited[nearestIndex];
            // ãƒ«ãƒ¼ãƒˆã«è¿½åŠ 
            route.push(next);
            // ç¾åœ¨åœ°ã‚’æ›´æ–°
            current = next;
            // è¨ªå•æ¸ˆã¿ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
            unvisited.splice(nearestIndex, 1);
            
            console.log(`æ¬¡ã®è¨ªå•å…ˆ: ${next.originalAddress || next.formattedAddress || 'ä¸æ˜'} (è·é›¢: ${minDistance.toFixed(2)}km)`);
        } else {
            console.warn("æœ€è¿‘ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
            break;
        }
    }
    
    // æœ€çµ‚ãƒ«ãƒ¼ãƒˆã‚’ãƒ­ã‚°è¡¨ç¤º
    console.log("æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ:");
    route.forEach((loc, idx) => {
        console.log(`${idx+1}: ${loc.originalAddress || loc.formattedAddress || 'ä¸æ˜'}`);
    });
    
    return route;
}

// ãƒãƒãƒ¼ã‚µã‚¤ãƒ³è·é›¢è¨ˆç®—ï¼ˆåœ°çƒä¸Šã®2ç‚¹é–“ã®è·é›¢ã‚’ã‚ˆã‚Šæ­£ç¢ºã«è¨ˆç®—ï¼‰
function haversineDistance(lat1, lon1, lat2, lon2) {
    // åœ°çƒã®åŠå¾„ï¼ˆkmï¼‰
    const R = 6371;
    
    // ç·¯åº¦ãƒ»çµŒåº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    
    // ãƒãƒãƒ¼ã‚µã‚¤ãƒ³å…¬å¼
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    return distance;
}

// ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹é–¢æ•°ã‚’è¿½åŠ 
function setRouteOptimizationOptions() {
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’å–å¾—ï¼ˆåˆå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ï¼‰
    let routeOptions = {
        travelMode: localStorage.getItem('travelMode') || 'DRIVING',
        avoidHighways: localStorage.getItem('avoidHighways') === 'true' || false,
        avoidTolls: localStorage.getItem('avoidTolls') === 'true' || false,
        optimizeWaypoints: true
    };
    
    return routeOptions;
}

// æœ€é©åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ”¹å–„ - ç§»å‹•æ™‚é–“ã‚’è€ƒæ…®
async function optimizeRouteWithDirections(start, locations) {
    // æœ€é©åŒ–è¨­å®šã‚’å–å¾—
    const routeOptions = setRouteOptimizationOptions();
    
    // è¨ªå•å…ˆãŒ3ç®‡æ‰€ä»¥ä¸‹ã®å ´åˆã¯å˜ç´”ãªæœ€è¿‘ç‚¹æ¢ç´¢ã§ååˆ†
    if (locations.length <= 3) {
        return nearestNeighborAlgorithm(start, locations);
    }
    
    try {
        // Google Directions Matrixã‚’ä½¿ç”¨ã—ã¦å®Ÿéš›ã®ç§»å‹•æ™‚é–“ã‚’å–å¾—
        const service = new google.maps.DistanceMatrixService();
        
        // å…¨åœ°ç‚¹ï¼ˆç¾åœ¨åœ° + è¨ªå•å…ˆï¼‰ã‚’å«ã‚€é…åˆ—ã‚’ä½œæˆ
        const allPoints = [start, ...locations.map(loc => ({ lat: loc.lat, lng: loc.lng }))];
        
        // è·é›¢è¡Œåˆ—è¨ˆç®—ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const request = {
            origins: allPoints,
            destinations: allPoints,
            travelMode: google.maps.TravelMode[routeOptions.travelMode],
            avoidHighways: routeOptions.avoidHighways,
            avoidTolls: routeOptions.avoidTolls
        };
        
        // è·é›¢è¡Œåˆ—ã‚’å–å¾—
        const matrix = await new Promise((resolve, reject) => {
            service.getDistanceMatrix(request, (response, status) => {
                if (status === 'OK') {
                    resolve(response);
                } else {
                    reject(new Error(`è·é›¢è¡Œåˆ—ã®å–å¾—ã«å¤±æ•—: ${status}`));
                }
            });
        });
        
        // è·é›¢è¡Œåˆ—ã‹ã‚‰ç§»å‹•æ™‚é–“ã‚’æŠ½å‡º
        const travelTimes = [];
        for (let i = 0; i < matrix.rows.length; i++) {
            travelTimes[i] = [];
            for (let j = 0; j < matrix.rows[i].elements.length; j++) {
                const element = matrix.rows[i].elements[j];
                if (element.status === 'OK') {
                    // ç§’å˜ä½ã®æ‰€è¦æ™‚é–“
                    travelTimes[i][j] = element.duration.value;
                } else {
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å¤§ããªå€¤ã‚’è¨­å®š
                    travelTimes[i][j] = 9999999;
                }
            }
        }
        
        // æ”¹è‰¯å‹æœ€è¿‘ç‚¹æ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆç§»å‹•æ™‚é–“ãƒ™ãƒ¼ã‚¹ï¼‰
        const route = [];
        const unvisited = [...Array(locations.length).keys()];
        let currentIndex = 0; // ç¾åœ¨åœ°ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        
        while (unvisited.length > 0) {
            // ç¾åœ¨åœ°ã‹ã‚‰æœ€ã‚‚ç§»å‹•æ™‚é–“ãŒçŸ­ã„æœªè¨ªå•åœ°ç‚¹ã‚’è¦‹ã¤ã‘ã‚‹
            let nearestIndex = -1;
            let shortestTime = Infinity;
            
            for (let i = 0; i < unvisited.length; i++) {
                const locationIndex = unvisited[i] + 1; // +1 ã¯ç¾åœ¨åœ°ãŒ[0]ã§ã‚ã‚‹ãŸã‚
                const time = travelTimes[currentIndex][locationIndex];
                
                if (time < shortestTime) {
                    shortestTime = time;
                    nearestIndex = i;
                }
            }
            
            if (nearestIndex === -1) break; // åˆ°é”ã§ããªã„å ´åˆã¯çµ‚äº†
            
            // æ¬¡ã®è¨ªå•å…ˆã‚’è¿½åŠ 
            const nextLocationIndex = unvisited[nearestIndex];
            route.push(locations[nextLocationIndex]);
            
            // ç¾åœ¨åœ°ã‚’æ›´æ–°
            currentIndex = nextLocationIndex + 1;
            
            // è¨ªå•æ¸ˆã¿ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
            unvisited.splice(nearestIndex, 1);
        }
        
        return route;
    } catch (error) {
        console.warn('æœ€é©åŒ–ã‚¨ãƒ©ãƒ¼ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ–¹æ³•ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å˜ç´”ãªæœ€è¿‘ç‚¹æ¢ç´¢ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        return nearestNeighborAlgorithm(start, locations);
    }
}

// ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–è¨­å®šUIã‚’è¿½åŠ  - HTMLã‚³ãƒ¼ãƒ‰
function addRouteOptimizationSettingsUI() {
    // ã™ã§ã«è¨­å®šUIãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if (document.getElementById('routeSettingsContainer')) {
        return;
    }
    
    // è¨­å®šUIã®HTML
    const settingsHTML = `
        <div class="card" id="routeSettingsContainer">
            <div class="step-title">
                <div class="step-number">âš™ï¸</div>
                <h2>ãƒ«ãƒ¼ãƒˆè¨­å®š</h2>
            </div>
            <div class="settings-container">
                <div class="setting-item">
                    <label for="travelModeSelect">ç§»å‹•æ‰‹æ®µ:</label>
                    <select id="travelModeSelect" class="settings-select">
                        <option value="DRIVING">è»Š</option>
                        <option value="WALKING">å¾’æ­©</option>
                        <option value="TRANSIT">å…¬å…±äº¤é€šæ©Ÿé–¢</option>
                        <option value="BICYCLING">è‡ªè»¢è»Š</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="avoidHighwaysCheck">é«˜é€Ÿé“è·¯ã‚’é¿ã‘ã‚‹:</label>
                    <input type="checkbox" id="avoidHighwaysCheck">
                </div>
                <div class="setting-item">
                    <label for="avoidTollsCheck">æœ‰æ–™é“è·¯ã‚’é¿ã‘ã‚‹:</label>
                    <input type="checkbox" id="avoidTollsCheck">
                </div>
            </div>
            <button id="saveSettingsButton">è¨­å®šã‚’ä¿å­˜</button>
        </div>
    `;
    
    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’headã«è¿½åŠ 
    const style = document.createElement('style');
    style.textContent = `
        .settings-container {
            margin-bottom: 15px;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        .settings-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
            width: 150px;
        }
    `;
    document.head.appendChild(style);
    
    // è¨­å®šUIã‚’æŒ¿å…¥ï¼ˆã‚¹ãƒ†ãƒƒãƒ—2ã®å‰ï¼‰
    const step2Element = document.getElementById('step2');
    step2Element.parentNode.insertBefore(
        createElementFromHTML(settingsHTML),
        step2Element
    );
    
    // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã‚€
    loadSavedSettings();
    
    // è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.getElementById('saveSettingsButton').addEventListener('click', saveRouteSettings);
}

// HTMLæ–‡å­—åˆ—ã‹ã‚‰DOMè¦ç´ ã‚’ä½œæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function createElementFromHTML(htmlString) {
    const div = document.createElement('div');
    div.innerHTML = htmlString.trim();
    return div.firstChild;
}

// ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã‚€
function loadSavedSettings() {
    try {
        const travelMode = localStorage.getItem('travelMode') || 'DRIVING';
        const avoidHighways = localStorage.getItem('avoidHighways') === 'true';
        const avoidTolls = localStorage.getItem('avoidTolls') === 'true';
        
        // UIè¦ç´ ã«è¨­å®šã‚’åæ˜ 
        document.getElementById('travelModeSelect').value = travelMode;
        document.getElementById('avoidHighwaysCheck').checked = avoidHighways;
        document.getElementById('avoidTollsCheck').checked = avoidTolls;
    } catch (e) {
        console.warn('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
    }
}

// ãƒ«ãƒ¼ãƒˆè¨­å®šã‚’ä¿å­˜
function saveRouteSettings() {
    try {
        const travelMode = document.getElementById('travelModeSelect').value;
        const avoidHighways = document.getElementById('avoidHighwaysCheck').checked;
        const avoidTolls = document.getElementById('avoidTollsCheck').checked;
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        localStorage.setItem('travelMode', travelMode);
        localStorage.setItem('avoidHighways', avoidHighways);
        localStorage.setItem('avoidTolls', avoidTolls);
        
        alert('ãƒ«ãƒ¼ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } catch (e) {
        console.error('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
        alert('è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
}

// æ”¹è‰¯ç‰ˆã®æœ€è¿‘ç‚¹æ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  - ã‚ˆã‚ŠåŠ¹ç‡çš„ãªãƒ«ãƒ¼ãƒˆè¨ˆç®—
function optimizeRouteWithNearestNeighbor(start, locations) {
    console.log("æ”¹è‰¯ç‰ˆæœ€è¿‘ç‚¹æ¢ç´¢ã§æœ€é©åŒ–ã‚’é–‹å§‹:", start);
    
    // æœªè¨ªå•åœ°ç‚¹ã®ãƒªã‚¹ãƒˆ
    const unvisited = [...locations];
    const route = [];
    
    // ç¾åœ¨åœ°ç‚¹ï¼ˆå‡ºç™ºç‚¹ï¼‰
    let currentPoint = { ...start };
    
    // ã™ã¹ã¦ã®åœ°ç‚¹ã‚’è¨ªå•ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
    while (unvisited.length > 0) {
        // æœ€ã‚‚è¿‘ã„åœ°ç‚¹ã‚’è¦‹ã¤ã‘ã‚‹
        let closestIndex = -1;
        let closestDistance = Infinity;
        
        for (let i = 0; i < unvisited.length; i++) {
            const distance = haversineDistance(
                currentPoint.lat, currentPoint.lng,
                unvisited[i].lat, unvisited[i].lng
            );
            
            // ã‚ˆã‚Šè¿‘ã„åœ°ç‚¹ã‚’è¦‹ã¤ã‘ãŸå ´åˆ
            if (distance < closestDistance) {
                closestDistance = distance;
                closestIndex = i;
            }
        }
        
        // æœ€å¯„ã‚Šã®åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆï¼ˆé€šå¸¸ã¯ã“ã“ã«ã¯æ¥ãªã„ï¼‰
        if (closestIndex === -1) {
            console.error("æœ€å¯„ã‚Šã®åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚");
            break;
        }
        
        // æœ€ã‚‚è¿‘ã„åœ°ç‚¹ã‚’ãƒ«ãƒ¼ãƒˆã«è¿½åŠ 
        const closestPoint = unvisited[closestIndex];
        route.push(closestPoint);
        
        // ç¾åœ¨åœ°ç‚¹ã‚’æ›´æ–°
        currentPoint = { ...closestPoint };
        
        // è¨ªå•æ¸ˆã¿ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
        unvisited.splice(closestIndex, 1);
        
        console.log(`æ¬¡ã®è¨ªå•å…ˆã‚’è¿½åŠ (${closestDistance.toFixed(2)}km): ${closestPoint.originalAddress || 'ä¸æ˜'}`);
    }
    
    console.log("æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ:", route.map(p => p.originalAddress || 'ä¸æ˜'));
    return route;
}

// ãƒãƒãƒ¼ã‚µã‚¤ãƒ³è·é›¢è¨ˆç®— - åœ°çƒä¸Šã®2ç‚¹é–“ã®æ­£ç¢ºãªè·é›¢ã‚’è¨ˆç®—
function haversineDistance(lat1, lng1, lat2, lng2) {
    // åœ°çƒã®åŠå¾„ï¼ˆkmï¼‰
    const R = 6371;
    
    // ç·¯åº¦ãƒ»çµŒåº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    
    // ãƒãƒãƒ¼ã‚µã‚¤ãƒ³å…¬å¼
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLng/2) * Math.sin(dLng/2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    return distance;
}

// ç°¡æ˜“åŒ–ã—ãŸãƒãƒãƒ¼ã‚µã‚¤ãƒ³è·é›¢è¨ˆç®— - é«˜é€Ÿã§æ­£ç¢º
function getHaversineDistance(lat1, lng1, lat2, lng2) {
  // åœ°çƒã®åŠå¾„ï¼ˆkmï¼‰
  const R = 6371;
  
  // ç·¯åº¦ãƒ»çµŒåº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
    Math.sin(dLng/2) * Math.sin(dLng/2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // è·é›¢ï¼ˆkmï¼‰
}
        
// 2ç‚¹é–“ã®è·é›¢ã‚’è¨ˆç®—
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // åœ°çƒã®åŠå¾„ï¼ˆkmï¼‰
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLng/2) * Math.sin(dLng/2);
        
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    return distance;
}


// ã‚·ãƒ³ãƒ—ãƒ«ãªæœ€è¿‘ç‚¹æ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  - å®Œå…¨ãªæ›¸ãæ›ãˆ
function simplestNearestNeighbor(start, locations) {
  console.log("ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ«ãƒ¼ãƒˆæœ€é©åŒ–ã‚’é–‹å§‹:", start);
  
  // æœªè¨ªå•åœ°ç‚¹ã®ãƒªã‚¹ãƒˆ
  const unvisited = [...locations];
  const route = [];
  
  // ç¾åœ¨åœ°ç‚¹ï¼ˆå‡ºç™ºç‚¹ï¼‰
  let currentPoint = { ...start };
  
  // ãƒ‡ãƒãƒƒã‚°ç”¨ã«å„åœ°ç‚¹ã‚’å‡ºåŠ›
  unvisited.forEach((loc, i) => {
    console.log(`åœ°ç‚¹ ${i+1}: ${loc.originalAddress || 'ä¸æ˜'} @ (${loc.lat}, ${loc.lng})`);
  });
  
  // ã™ã¹ã¦ã®åœ°ç‚¹ã‚’è¨ªå•ã™ã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™
  while (unvisited.length > 0) {
    // æœ€ã‚‚è¿‘ã„åœ°ç‚¹ã‚’è¦‹ã¤ã‘ã‚‹
    let closestIndex = 0;
    let closestDistance = getSimpleDistance(
      currentPoint.lat, currentPoint.lng,
      unvisited[0].lat, unvisited[0].lng
    );
    
    // å…¨ã¦ã®æœªè¨ªå•åœ°ç‚¹ã‚’ãƒã‚§ãƒƒã‚¯
    for (let i = 1; i < unvisited.length; i++) {
      const distance = getSimpleDistance(
        currentPoint.lat, currentPoint.lng,
        unvisited[i].lat, unvisited[i].lng
      );
      
      // ã‚ˆã‚Šè¿‘ã„åœ°ç‚¹ã‚’è¦‹ã¤ã‘ãŸå ´åˆ
      if (distance < closestDistance) {
        closestDistance = distance;
        closestIndex = i;
      }
    }
    
    // æœ€ã‚‚è¿‘ã„åœ°ç‚¹ã‚’ãƒ«ãƒ¼ãƒˆã«è¿½åŠ 
    const closestPoint = unvisited[closestIndex];
    route.push(closestPoint);
    
    // ç¾åœ¨åœ°ç‚¹ã‚’æ›´æ–°
    currentPoint = { ...closestPoint };
    
    // è¨ªå•æ¸ˆã¿ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
    unvisited.splice(closestIndex, 1);
    
    console.log(`æ¬¡ã®è¨ªå•å…ˆã‚’è¿½åŠ : ${closestPoint.originalAddress || 'ä¸æ˜'}`);
  }
  
  console.log("æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ:", route.map(p => p.originalAddress || 'ä¸æ˜'));
  return route;
}

// å˜ç´”ãªè·é›¢è¨ˆç®—é–¢æ•°
function getSimpleDistance(lat1, lng1, lat2, lng2) {
  return Math.sqrt(
    Math.pow(lat2 - lat1, 2) + 
    Math.pow(lng2 - lng1, 2)
  );
}
        
// ãƒ«ãƒ¼ãƒˆã¨ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° - é †åºä¿®æ­£ç‰ˆ
function displayRoute(start, optimizedLocations) {
    if (!start || !optimizedLocations || optimizedLocations.length === 0) {
        console.error('ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', { start, locationsCount: optimizedLocations ? optimizedLocations.length : 0 });
        return;
    }

    // ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    clearMarkers();

    // ç¾åœ¨åœ°ã®ãƒãƒ¼ã‚«ãƒ¼
    const startMarker = new google.maps.Marker({
        position: start,
        map: map,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: "#0f9d58",
            fillOpacity: 1,
            strokeWeight: 0,
            scale: 12
        },
        title: "ç¾åœ¨åœ°ï¼ˆå‡ºç™ºç‚¹ï¼‰"
    });
    markers.push(startMarker);

    // è¨ªå•å…ˆãƒãƒ¼ã‚«ãƒ¼ - æœ€é©åŒ–ã•ã‚ŒãŸé †åºã§è¡¨ç¤º
    for (let i = 0; i < optimizedLocations.length; i++) {
        const location = optimizedLocations[i];
        
        // ãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ 
        const marker = new google.maps.Marker({
            position: { lat: location.lat, lng: location.lng },
            map: map,
            label: {
                text: String(i + 1),  // æœ€é©åŒ–ã•ã‚ŒãŸé †åºã§ç•ªå·ä»˜ã‘
                color: "white"
            },
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: "#4285f4",
                fillOpacity: 1,
                strokeWeight: 0,
                scale: 12
            },
            title: location.originalAddress || location.formattedAddress || `ä½ç½® ${i+1}`
        });
        
        markers.push(marker);
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ã«ãƒãƒ¼ã‚«ãƒ¼æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
        console.log(`ãƒãƒ¼ã‚«ãƒ¼ ${i+1}: ${marker.title} @ (${location.lat}, ${location.lng})`);
    }

    // ãƒ«ãƒ¼ãƒˆãŒ1ã‹æ‰€ã—ã‹ãªã„å ´åˆã¯Directions APIã‚’ä½¿ã‚ãšã€åœ°å›³ã®ä¸­å¿ƒã¨æ‹¡å¤§ç‡ã ã‘èª¿æ•´
    if (optimizedLocations.length === 1) {
        map.setCenter(optimizedLocations[0]);
        map.setZoom(14);
        return;
    }

    // Google Maps Directions APIã§ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º
    try {
        // æœ€é©åŒ–ã•ã‚ŒãŸé †åºã§ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
        const waypoints = optimizedLocations.slice(0, -1).map(location => ({
            location: new google.maps.LatLng(location.lat, location.lng),
            stopover: true
        }));
        
        const request = {
            origin: new google.maps.LatLng(start.lat, start.lng),
            destination: new google.maps.LatLng(
                optimizedLocations[optimizedLocations.length - 1].lat, 
                optimizedLocations[optimizedLocations.length - 1].lng
            ),
            waypoints: waypoints,
            optimizeWaypoints: false, // æ—¢ã«æœ€é©åŒ–æ¸ˆã¿ãªã®ã§false
            travelMode: google.maps.TravelMode.DRIVING
        };
        
        directionsService.route(request, (result, status) => {
            if (status === "OK") {
                directionsRenderer.setDirections(result);
                
                // ç·æ‰€è¦æ™‚é–“ã¨ç·è·é›¢ã‚’è¡¨ç¤º
                if (result.routes && result.routes.length > 0) {
                    const route = result.routes[0];
                    let totalDistance = 0;
                    let totalDuration = 0;
                    
                    route.legs.forEach(leg => {
                        totalDistance += leg.distance.value;
                        totalDuration += leg.duration.value;
                    });
                    
                    // è·é›¢ã¨æ™‚é–“ã®è¡¨ç¤º
                    const distanceKm = (totalDistance / 1000).toFixed(1);
                    const durationMin = Math.round(totalDuration / 60);
                    
                    // ãƒ«ãƒ¼ãƒˆæƒ…å ±ã‚’è¡¨ç¤º
                    const routeInfoDiv = document.createElement('div');
                    routeInfoDiv.className = 'address-item';
                    routeInfoDiv.innerHTML = `<strong>ãƒ«ãƒ¼ãƒˆæƒ…å ±:</strong> ç·è·é›¢: ${distanceKm}km, æ¨å®šæ‰€è¦æ™‚é–“: ${durationMin}åˆ†`;
                    document.getElementById('optimizedAddressList').prepend(routeInfoDiv);
                    
                    console.log(`ãƒ«ãƒ¼ãƒˆæƒ…å ±: ç·è·é›¢=${distanceKm}km, æ¨å®šæ‰€è¦æ™‚é–“=${durationMin}åˆ†`);
                }
            } else {
                console.error("ãƒ«ãƒ¼ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼:", status);
                // ãƒ«ãƒ¼ãƒˆè¨ˆç®—ã«å¤±æ•—ã—ãŸå ´åˆã§ã‚‚ãƒãƒ¼ã‚«ãƒ¼ã¯è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€
                // åœ°å›³ã®è¡¨ç¤ºé ˜åŸŸã‚’èª¿æ•´
                fitMapToMarkers();
            }
        });
    } catch (error) {
        console.error("ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:", error);
        fitMapToMarkers();
    }
}

// ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–è¨­å®šUIã‚’è¿½åŠ  - HTMLã‚³ãƒ¼ãƒ‰
function addRouteOptimizationSettingsUI() {
    // ã™ã§ã«è¨­å®šUIãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if (document.getElementById('routeSettingsContainer')) {
        return;
    }
    
    // è¨­å®šUIã®HTML
    const settingsHTML = `
        <div class="card" id="routeSettingsContainer">
            <div class="step-title">
                <div class="step-number">âš™ï¸</div>
                <h2>ãƒ«ãƒ¼ãƒˆè¨­å®š</h2>
            </div>
            <div class="settings-container">
                <div class="setting-item">
                    <label for="travelModeSelect">ç§»å‹•æ‰‹æ®µ:</label>
                    <select id="travelModeSelect" class="settings-select">
                        <option value="DRIVING">è»Š</option>
                        <option value="WALKING">å¾’æ­©</option>
                        <option value="TRANSIT">å…¬å…±äº¤é€šæ©Ÿé–¢</option>
                        <option value="BICYCLING">è‡ªè»¢è»Š</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="avoidHighwaysCheck">é«˜é€Ÿé“è·¯ã‚’é¿ã‘ã‚‹:</label>
                    <input type="checkbox" id="avoidHighwaysCheck">
                </div>
                <div class="setting-item">
                    <label for="avoidTollsCheck">æœ‰æ–™é“è·¯ã‚’é¿ã‘ã‚‹:</label>
                    <input type="checkbox" id="avoidTollsCheck">
                </div>
            </div>
            <button id="saveSettingsButton">è¨­å®šã‚’ä¿å­˜</button>
        </div>
    `;
    
    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’headã«è¿½åŠ 
    const style = document.createElement('style');
    style.textContent = `
        .settings-container {
            margin-bottom: 15px;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        .settings-select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
            width: 150px;
        }
    `;
    document.head.appendChild(style);
    
    // è¨­å®šUIã‚’æŒ¿å…¥ï¼ˆã‚¹ãƒ†ãƒƒãƒ—2ã®å‰ï¼‰
    const step2Element = document.getElementById('step2');
    step2Element.parentNode.insertBefore(
        createElementFromHTML(settingsHTML),
        step2Element
    );
    
    // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã‚€
    loadSavedSettings();
    
    // è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.getElementById('saveSettingsButton').addEventListener('click', saveRouteSettings);
}
        
// æœ€é©åŒ–ã•ã‚ŒãŸä½æ‰€ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º - ã‚·ãƒ³ãƒ—ãƒ«æœ€çµ‚ç‰ˆ
function displayOptimizedAddressList(optimizedLocations) {
    // ãƒ‡ãƒãƒƒã‚°
    console.log("ãƒªã‚¹ãƒˆè¡¨ç¤º - æœ€é©åŒ–ã•ã‚ŒãŸè¨ªå•å…ˆ:", optimizedLocations);
    
    const container = document.getElementById('optimizedAddressList');
    container.innerHTML = '';
    
    // ç¾åœ¨åœ°è¡¨ç¤º
    const currentItem = document.createElement('div');
    currentItem.className = 'address-item';
    currentItem.innerHTML = '<strong>0: ç¾åœ¨åœ°ï¼ˆå‡ºç™ºç‚¹ï¼‰</strong>';
    container.appendChild(currentItem);
    
    // ãƒ«ãƒ¼ãƒˆæƒ…å ±è¡¨ç¤ºï¼ˆè·é›¢ã¨æ™‚é–“ï¼‰
    if (typeof totalDistance !== 'undefined' && typeof totalDuration !== 'undefined') {
        const routeInfoDiv = document.createElement('div');
        routeInfoDiv.className = 'address-item';
        const distanceKm = (totalDistance / 1000).toFixed(1);
        const durationMin = Math.round(totalDuration / 60);
        routeInfoDiv.innerHTML = `<strong>ãƒ«ãƒ¼ãƒˆæƒ…å ±:</strong> ç·è·é›¢: ${distanceKm}km, æ¨å®šæ‰€è¦æ™‚é–“: ${durationMin}åˆ†`;
        container.appendChild(routeInfoDiv);
    }
    
    // å„è¨ªå•å…ˆã‚’è¡¨ç¤º
    optimizedLocations.forEach((location, index) => {
        const addressItem = document.createElement('div');
        addressItem.className = 'address-item';
        
        // ä½æ‰€ãƒ†ã‚­ã‚¹ãƒˆã‚’æ±ºå®š
        const addressText = location.originalAddress || location.formattedAddress || `ä½ç½® (${location.lat}, ${location.lng})`;
        
        addressItem.innerHTML = `<strong>${index + 1}:</strong> ${addressText}`;
        container.appendChild(addressItem);
    });
}
        
// Google ãƒãƒƒãƒ—ã§é–‹ãé–¢æ•°ã®æ”¹å–„
function openInGoogleMaps() {
    if (optimizedAddresses.length === 0) {
        alert('æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // Google ãƒãƒƒãƒ—ã§é–‹ããŸã‚ã®URLã‚’ä½œæˆ
    let url = `https://www.google.com/maps/dir/?api=1`;
    
    // ç¾åœ¨åœ°ã‚’å‡ºç™ºç‚¹ã¨ã—ã¦è¨­å®š
    url += `&origin=${currentPosition.lat},${currentPosition.lng}`;
    
    // æœ€å¾Œã®åœ°ç‚¹ã‚’ç›®çš„åœ°ã¨ã—ã¦è¨­å®š
    const lastLocation = optimizedAddresses[optimizedAddresses.length - 1];
    url += `&destination=${lastLocation.lat},${lastLocation.lng}`;
    
    // çµŒç”±åœ°ç‚¹ã‚’è¨­å®šï¼ˆæœ€å¤§9ç®‡æ‰€ã¾ã§Google Mapsã§å¯¾å¿œï¼‰
    if (optimizedAddresses.length > 1) {
        // Google Mapsã®åˆ¶é™ã«åˆã‚ã›ã¦çµŒç”±åœ°ç‚¹ã‚’åˆ¶é™
        const maxWaypoints = Math.min(optimizedAddresses.length - 1, 9);
        const waypoints = optimizedAddresses.slice(0, maxWaypoints).map(loc => `${loc.lat},${loc.lng}`).join('|');
        url += `&waypoints=${waypoints}`;
        
        // çµŒç”±åœ°ç‚¹ãŒåˆ¶é™ã‚’è¶…ãˆã‚‹å ´åˆã¯è­¦å‘Š
        if (optimizedAddresses.length - 1 > 9) {
            alert(`æ³¨æ„: Google Mapsã§ã¯æœ€å¤§9ç®‡æ‰€ã®çµŒç”±åœ°ç‚¹ã—ã‹è¨­å®šã§ãã¾ã›ã‚“ã€‚\næ®‹ã‚Šã®${optimizedAddresses.length - 10}ç®‡æ‰€ã¯çœç•¥ã•ã‚Œã¾ã™ã€‚`);
        }
    }
    
    // ç§»å‹•ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
    url += `&travelmode=driving`;
    
    // æ–°ã—ã„ã‚¿ãƒ–ã§Google ãƒãƒƒãƒ—ã‚’é–‹ã
    window.open(url, '_blank');
}

        

// Google ãƒãƒƒãƒ—APIã®èª­ã¿è¾¼ã¿é–¢æ•°ã®ä¿®æ­£
function loadGoogleMapsApi() {
    console.log('Google Maps APIã‚’èª­ã¿è¾¼ã¿ä¸­...');
    
    // æ—¢ã«èª­ã¿è¾¼ã¿ä¸­ã¾ãŸã¯èª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã¯å‡¦ç†ã—ãªã„
    if (document.getElementById('google-maps-api')) {
        console.log('Google Maps APIã¯æ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹èª­ã¿è¾¼ã¿ä¸­ã§ã™');
        return;
    }

    const script = document.createElement('script');
    script.id = 'google-maps-api';
    script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAg27IKRj6lWefypqphZ-RRYcZWX-bMscw&libraries=places&callback=initMap';
    script.defer = true;
    script.async = true;
    
    // æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ï¼‰
    window.initMap = function() {
        console.log('Google Maps APIèª­ã¿è¾¼ã¿æˆåŠŸ - åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™');
        initMap(); // é–¢æ•°ã‚’å‘¼ã³å‡ºã—
    };
    
    script.onerror = function() {
        console.error('Google Maps APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        document.getElementById('errorMessage').textContent = 'Google Maps APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('loadingProcess').style.display = 'none';
        document.getElementById('processAddressesButton').disabled = false;
    };
    
    document.head.appendChild(script);
    console.log('Google Maps APIã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}

// ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
function clearMarkers() { 
    for (let i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
    }
    markers = [];
}

// åœ°å›³ã®è¡¨ç¤ºé ˜åŸŸã‚’ãƒãƒ¼ã‚«ãƒ¼ã«åˆã‚ã›ã‚‹
function fitMapToMarkers() {
    if (markers.length === 0) return;
    
    const bounds = new google.maps.LatLngBounds();
    for (let i = 0; i < markers.length; i++) {
        bounds.extend(markers[i].getPosition());
    }
    map.fitBounds(bounds);
}

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆå•é¡Œè§£æ±ºå¾Œã«å‰Šé™¤å¯èƒ½ï¼‰
function showDebugInfo() {
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ç”¨ã®è¦ç´ ã‚’è¿½åŠ 
    if (!document.getElementById('debugInfo')) {
        const debugDiv = document.createElement('div');
        debugDiv.id = 'debugInfo';
        debugDiv.style.cssText = 'padding: 10px; background-color: #f8f9fa; border: 1px solid #ddd; margin: 10px 0; font-size: 12px; display: none;';
        
        const toggleButton = document.createElement('button');
        toggleButton.textContent = 'ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º';
        toggleButton.style.cssText = 'background-color: #6c757d; color: white; border: none; padding: 5px 10px; margin-top: 10px; font-size: 12px;';
        toggleButton.onclick = function() {
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv.style.display === 'none') {
                debugDiv.style.display = 'block';
                this.textContent = 'ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’éš ã™';
                updateDebugInfo();
            } else {
                debugDiv.style.display = 'none';
                this.textContent = 'ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º';
            }
        };
        
        // ã‚³ãƒ³ãƒ†ãƒŠã®æœ€å¾Œã«è¿½åŠ 
        const container = document.querySelector('.container');
        container.appendChild(toggleButton);
        container.appendChild(debugDiv);
    }
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateDebugInfo() {
        const debugDiv = document.getElementById('debugInfo');
        if (debugDiv && debugDiv.style.display !== 'none') {
            let html = '<h4>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h4>';
            
            // ä½ç½®æƒ…å ±
            html += '<h5>ä½ç½®æƒ…å ±:</h5>';
            html += `<p>ç¾åœ¨ä½ç½®: ${currentPosition ? `(${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)})` : 'æœªè¨­å®š'}</p>`;
            
            // ä½æ‰€ãƒªã‚¹ãƒˆ
            html += '<h5>ä½æ‰€ãƒªã‚¹ãƒˆ:</h5>';
            html += '<ul>';
            if (addresses && addresses.length) {
                addresses.forEach((addr, i) => {
                    html += `<li>${i+1}: ${addr}</li>`;
                });
            } else {
                html += '<li>ä½æ‰€ãŒã‚ã‚Šã¾ã›ã‚“</li>';
            }
            html += '</ul>';
            
            // æœ€é©åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ
            html += '<h5>æœ€é©åŒ–ãƒ«ãƒ¼ãƒˆ:</h5>';
            html += '<ul>';
            if (optimizedAddresses && optimizedAddresses.length) {
                optimizedAddresses.forEach((loc, i) => {
                    const addrText = loc.originalAddress || loc.formattedAddress || 'ä¸æ˜';
                    html += `<li>${i+1}: ${addrText} (${loc.lat.toFixed(6)}, ${loc.lng.toFixed(6)})</li>`;
                });
            } else {
                html += '<li>ãƒ«ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</li>';
            }
            html += '</ul>';
            
            // ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±
            html += '<h5>ç’°å¢ƒæƒ…å ±:</h5>';
            html += `<p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent}</p>`;
            html += `<p>ç”»é¢ã‚µã‚¤ã‚º: ${window.innerWidth}x${window.innerHeight}</p>`;
            html += `<p>ä½ç½®æƒ…å ±ã‚µãƒãƒ¼ãƒˆ: ${navigator.geolocation ? 'ã‚ã‚Š' : 'ãªã—'}</p>`;
            
            debugDiv.innerHTML = html;
            
            // 30ç§’ã”ã¨ã«æ›´æ–°
            setTimeout(updateDebugInfo, 30000);
        }
    }
}

    </script>
</body>
</html>
